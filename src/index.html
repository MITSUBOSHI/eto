<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
  <title></title>
</head>
<body>
  <div class="container-sm p-5">
    <button type="button" class="btn btn-sm btn-primary my-3 px-3" onclick="main()">Run</button>
    <div id="result"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ruby-head-wasm-wasi@latest/dist/browser.umd.js"></script>
  <script>

    const { DefaultRubyVM } = window["ruby-wasm-wasi"];
    const main = async () => {
      const response = await fetch('./etoji.wasm')
      const buffer = await response.arrayBuffer();
      const module = await WebAssembly.compile(buffer)

      const { vm } = await DefaultRubyVM(module);

      vm.printVersion();
      const res = vm.eval(`
        load "etoji/lib/etoji.rb"

        class CurrentAnimalDetector
          def initialize(year:)
            @year = year
          end

          def detect
            result = ::Etoji.geto(year: @year, with_prev: true, with_next: true)

            {
              prev: { emoji: result[0].emoji, character: result[0].character, year: @year - 1 },
              current: { emoji: result[1].emoji, character: result[1].character, year: @year },
              next: { emoji: result[2].emoji, character: result[2].character, year: @year + 1 },
            }.to_json
          end
        end
        CurrentAnimalDetector.new(year: 2023).detect
      `)

      const result = document.getElementById('result')
      console.log(res.toString);
      result.innerText = res.toString()
    }
    main();
  </script>
</body>
</html>
